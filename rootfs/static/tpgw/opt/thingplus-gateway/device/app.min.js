/*
 * Copyright (c) 2014, Daliworks. All rights reserved.
 *
 * Reproduction and/or distribution in source and binary forms 
 * without the written consent of Daliworks, Inc. is prohibited.
 *
 */
!function(a,b){function c(b,d){var e,f;if("."!=b[0]&&"/"!=b[0])return a(b);if(d=d||"root",e=c.resolve(b),!e&&/\.json$/i.test(b))return a("./"+c.basename(b));if(f=c.cache[e],!f)throw Error('failed to require "'+b+'" from '+d);return f.exports||(f.exports={},f.call(f.exports,f,f.exports,c.relative(e))),f.exports}c.cache={},c.basename=a("path").basename,c.resolve=function(b){var d,e,f;if("."!=b[0])return a.resolve(b);for(d=[b,b+".js",b+"/index.js",b+".json",b+"/index.json"],e=0;f=d[e];e++)if(c.cache[f])return f},c.register=function(a,b){c.cache[a]=b},c.relative=function(a){function b(b){var d,e,f,g,h;if("."!=b[0])return c(b);for(d=a.split("/"),e=b.split("/"),d.pop(),f=0,g=e.length;g>f;f+=1)h=e[f],".."==h?d.pop():"."!=h&&d.push(h);return c(d.join("/"),a)}return b.resolve=c.resolve,b.cache=c.cache,b},c.register("./app.js",function(a,b,c){"use strict";var r,A,B,F,H,I,J,K,L,M,N,d=c("express"),e=c("errorhandler"),f=c("body-parser"),g=c("multer"),h=c("method-override"),i=c("serve-favicon"),j=c("morgan"),k=c("http-auth"),l=c("optimist"),m=c("async"),n=c("log4js"),o=c("os"),p=c("config"),q=c("dgram"),s=c("./routes"),t=c("./gateway"),u=c("./server"),v=c("./sensors"),w=c("./utils"),x=c("./store"),y=c("./mqtt"),z=c("./remotecontroller"),C=!1,D=l.usage("Sensorjs app",{logger:{description:"logger configuration json","default":__dirname+"/logger_cfg.json",alias:"l",string:!0},help:{description:"print help",alias:"h"}}).argv,E=process.env.NODE_ENV||"development";D.h&&(l.showHelp(),process.exit(0)),n.configure(D.logger,{reloadSecs:30}),F=n.getLogger("Main"),F.info("... Starting [%s] ...",o.hostname());try{r=c("memwatch")}catch(G){F.warn("MODULES_NOT_SUPPORTED - memwatch")}try{A=c("sensorjs/lib/sensor/driver/rgbLed")}catch(G){F.warn("MODULES_NOT_SUPPORTED - rgbLed")}H=A&&new A({device:{address:66},model:"rgbLed",id:"redLed-66"}),I=A&&new A({device:{address:68},model:"rgbLed",id:"greenLed-68"}),J=A&&new A({device:{address:69},model:"rgbLed",id:"yellowLed-69"}),setTimeout(function(){C?F.info("[init check] initialized OK"):(F.fatal("[init check] restart due to NOT being initialized within ",p.Init.timeout),z.process("restart"))},p.Init.timeout),K=d(),K.set("port",p.Gateway.port||80),K.set("views",__dirname+"/da_views"),K.set("view engine","jade"),K.set("root",__dirname),K.use(i(__dirname+"/../device_ui/app/favicon.ico")),K.use(j("dev")),K.use(f()),K.use(h()),K.get("/api/gateway/ping",function(a,b){C?b.end():b.send(503,"gateway not ready")}),K.use(k.connect(k.digest({realm:"Sensor.js"},function(a,b){b(p.Auth[a])}))),K.use(d.static(__dirname+"/../device_ui/app")),K.use(g({dest:"./api/certUpload"})),K.get("/api/gateway/info",s.gatewayInfo()),K.put("/api/gateway/config",s.gatewayConfig()),K.get("/api/gateway/control",s.gatewayControl()),K.get("/api/server/info",s.serverInfo()),K.get("/api/software/info",s.softwareInfo()),K.get("/api/sensor/data",s.sensorData()),K.get("/api/sensor/discover",s.sensorDiscover()),K.get("/api/sensors/:id",s.getSensorItem()),K.delete("/api/sensors/:id",s.delSensorItem()),K.post("/api/sensor/register",s.postSensorItem()),K.post("/api/certUpload",s.certUpload()),K.get("/api/interfaces",s.getInterfaces()),K.get("/api/interfaces/:id",s.getInterfaceItem()),K.get("/api/modems",s.getModems()),K.get("/api/modems/:id",s.getModemItem()),K.put("/api/modems/:id",s.putModemItem()),K.get("/api/modem/stats",s.getModemStats()),K.post("/api/chpasswd",s.chPasswd()),K.post("/api/actuator/control",s.controlActuator()),K.get("/api/sensorDrivers",s.getSensorDrivers()),"development"===E&&K.use(e({dumpExceptions:!0})),H&&H.blink(),m.series([function(a){F.info("1. get mac"),w.getId("mac",function(b,c){!b&&c?(B=c,a()):a(Error("failure to get id"))})},function(a){F.info("2. store init"),x.init(a)},function(a){var b,c;F.info("3. mqtt init"),b=p.Server.mqtt;try{c="mqtts"===b.protocol?{pfxPath:p.Gateway.CERT_FILE_PATH,caPath:p.Gateway.CA_FILE_PATH,passphrase:B,rejectUnauthorized:!0}:null,y.init(parseInt(b.port,10)||1883,b.host,B,c,x,function(b){return b&&F.error("mqtt.init() "+b.stack),a()})}catch(d){return F.error("mqtt.init exception=",d),a()}},function(a){F.info("4. server init");try{u.init(B,a)}catch(b){return a()}},function(a){F.info("5. gateway init");try{t.init(B,a)}catch(b){return a(b)}},function(a){F.info("6. sensor init");try{v.init(a)}catch(b){return a(b)}}],function(a){a?(F.fatal("init error",a),setTimeout(function(){z.process("restart")},3e4)):H&&H.on(),K.listen(K.get("port")),F.warn("... Listening on port %s ...",K.get("port")),C=!0}),w.monitor.on("mqtt",function(a){switch(a){case"active":J&&J.blink(500,5e3);break;case"connected":t.initialized&&(t.synced||t.sync(function(a){a?F.error("gateway sync at mqtt connect FAILURE",a):F.warn("gateway sync at mqtt connect SUCCESS")})),y.publish(y.topic.status,""+["on",(t.reportInterval||6e4)/1e3*1.5]),H&&H.on();break;case"closed":case"error":H&&H.blink()}}),w.monitor.on("sensor",function(a){"active"===a&&I&&I.blink(500,5e3)}),w.monitor.on("actuator",function(a,b,c){var d,e;"command"===a&&(d=b,e=b.options,v.controlActuator(d,e,function(a,b){return a?(F.error("[sensors-controlActuator]",a),c&&c(a)):(F.info("[sensors-controlActuator]",b),c&&c(null,b))}))}),w.monitor.on("time",function(a){"synced"===a&&F.info("time: IN SYNC")}),w.monitor.on("store",function(a,b,c){"tooold"===a&&(F.fatal("[reboot] 1 day old data is not send oldestVal=%j queuedSize=%d",b,c),z.process("reboot",null,function(a,b){a?F.fatal("[reboot] failed err=",a):F.info("[reboot] result=",b)}))}),process.on("uncaughtException",function(a){F.error("[uncaughtException] "+a.stack)}),process.on("exit",function(){F.info("exit"),H&&H.off(),I&&I.off(),J&&J.off()}),process.on("SIGTERM",function(){F.info("SIGTERM"),process.exit()}),r&&(r.on("stats",function(a){F.debug("[memwatch] stats=",a)}),r.on("leak",function(a){F.error("[memwatch] leak=",a)})),L=q.createSocket("udp4"),M=28282,N="Thing+?",L.bind(M,function(){F.info("discovery BOUND port=[%d]",M)}),L.on("message",function(a,b){if(F.debug("discovery msg",""+a),F.debug("discovery rinfo",b),""+a!==N)return void F.info("discovery ignore unknown request");var c=new Buffer(JSON.stringify({id:B,name:t&&t.name,service:p.Server&&p.Server.service&&p.Server.service.host,mqtt:p.Server&&p.Server.mqtt&&p.Server.mqtt.host,uptime:""+(o.uptime()/60).toFixed(0)+"m"}));L.send(c,0,c.length,b.port,b.address),F.info("discovery reply myinfo=",""+c)})}),c.register("./etsi.js",function(a,b,c){"use strict";function p(a,b){var d="locationContainer"===Object.keys(a)[0],e=d?a.locationContainer.id:a.container.id;f||(f=c("m2mcore").httpBinder),f.primitiveRequest({targetID:n+"/containers",requestingEntity:n,primitiveType:d?"LOCATION_CONTAINER_CREATE_REQUEST":"CONTAINER_CREATE_REQUEST",rsc:a},function(a,c){return a||"STATUS_CREATED"!==c.statusCode?"STATUS_CONFLICT"===a.statusCode?b(null,n+"/containers/"+e):b(a||Error(c.statusCode)):b(a,c.resourceURI)})}var k,l,m,n,d=c("lodash"),e=c("log4js").getLogger("Main"),f=c("m2mcore").httpBinder,g=c("m2mcore").primitive,h=c("m2mcore").monitor,i=c("./sensors"),j=c("./gateway"),o={};a.exports.init=function(a,b,c){f.init({sclInfo:a},function(a){var b,k;return a?(e.error("httpBinder.init() "+a.stack),c(Error(f.init()))):(b=g.sclInfo,k=b.hSclBase+"/applications/"+b.id,0===b.protocol.indexOf("http")&&l(),d.each(i.sensorsData,function(a,b){m(b,b,j.sensors[b].type,i.sensorsData[b].interval,i.sensorsData[b].firstDelay)}),b=g.sclInfo,k=b.hSclBase+"/applications/"+b.id,e.info("... http initialized."),h.on("registration",function(){l()}),h.on("registration updated",function(){}),h.on("disconnect",function(a){e.error("disconnect url= ",a)}),c&&c())})},k=function(a,b){f.primitiveRequest({targetID:a+"/contentInstances",requestingEntity:n,primitiveType:"CONTENT_INSTANCE_CREATE_REQUEST",rsc:{contentInstance:{contentTypes:{contentType:["application/json"]},content:b}}},function(){})},l=function(){function a(a){var b=o[a];p({container:b.config},function(c,d){return c?void e.error("container creatin failure: ",c):(b.url=d,void e.debug("container:"+a+" url="+d))})}d.forOwn(o,function(b){e.debug("... making container for",b),a(b)})},m=function(a,b,c,d,e){var f=!1,g=null;o[a]={config:{id:b,maxNrOfInstances:100},url:g,available:f,type:c,interval:d,firstDelay:e}}}),c.register("./gateway.js",function(a,b,c){"use strict";var l,m,d=c("log4js").getLogger("Gateway"),e=c("config"),f=c("lodash"),g=c("retry"),h=c("./server"),i=c("./utils"),j=6e4,k=Number(e.Gateway&&e.Gateway.reportInterval,10)||j;k=j>k?j:k,l=i.statusError,m=a.exports={synced:!1,initialized:!1},m.putItem=function(a,b){void 0!==a.reportInterval&&(a.reportInterval=a.reportInterval>j?a.reportInterval:j),h.putGateway(a,b)},m.init=function(a,b){var c=this;this.id=a,this.name=e.Gateway.name,this.sensors=e.Sensors,this.reportInterval=k,this.initialized&&d.error("Gateway init, already initailzied"),i.getBoardInfo(function(a,i){!a&&i&&(c.board=i),d.info("[Gateway.init] board=",i),h._getGateway({embed:"sensors"},function(a,h){var i,k,l;return c.initialized=!0,a?(i=g.operation({retries:30,maxTimeout:72e5}),i.attempt(function(a){return c.synced?void d.warn("gateway.sync SUCCESS, tries:[%d]",a):void m.sync(function(b){return c.synced?void d.warn("gateway.sync SUCCESS, tries:[%d]",a):void(i.retry(b)&&d.error("gateway.sync FAILURE, tries:[%d]",a,b))})}),d.error("Gateway init, NOT IN SYNC, ignoring",a),b&&b()):(k={},void 0!==h.reportInterval&&(l=Number(h.reportInterval,10),l=l>j?l:j,c.reportInterval=l),e.Gateway.name=h.name?h.name:c.name,e.Gateway.reportInterval=c.reportInterval,h.sensors&&f.forEach(h.sensors,function(a){a&&f.isObject(a)&&a.id&&(k[a.id]=a)}),e.Sensors=k,c.sensors=e.Sensors,c.model=h.model,c.devices=h.devices,c.synced=!0,c.lastSync=Date.now(),d.warn("Gateway.init",JSON.stringify(c,null,2)),b&&b())})})},m.sync=function(a){var b=c("./sensors"),g=this;return this.initialized?void h._getGateway({embed:"sensors"},function(c,h){var i,k,l,n;return c?(d.error("Gateway init, server sync err=",c),a&&a(c)):(i={},void 0!==h.reportInterval&&(k=Number(h.reportInterval,10),k=k>j?k:j,g.reportInterval=k),e.Gateway.name=h.name?h.name:g.name,e.Gateway.reportInterval=g.reportInterval,h.sensors&&f.forEach(h.sensors,function(a){a&&f.isObject(a)&&a.id&&(i[a.id]=a)}),l=f.difference(f.keys(i),f.keys(m.sensors)),n=f.difference(f.keys(m.sensors),f.keys(i)),f.each(l,function(a){b.newSensor(a,i[a])}),f.each(n,function(a){b.removeSensor(a)}),g.synced=!0,g.lastSync=Date.now(),d.warn("Gateway.sync",JSON.stringify(g,null,2)),a&&a())}):(d.error("Gateway.sync, initialize first"),a&&a(l(400,"not initialized")))}}),c.register("./mqtt.js",function(a,b,c){"use strict";function v(b){u=[m,n,o,b].join("/"),t={base:u,logFilter:u+"/log/filter",log:u+"/log",status:u+"/status",mqttStatus:u+"/mqtt/status",rpcRequest:u+"/req",rpcResponse:u+"/res",getSensor:function(a){return[u,p,a].join("/")},getSensorStatus:function(a){return[u,p,a,"status"].join("/")},getActuator:function(a){return[u,q,a].join("/")}},a.exports.topic=t}var t,u,d=c("log4js").getLogger("MQTT"),e=c("./mqttHelper"),f=c("./remotecontroller"),g=c("util"),h=c("./mqtt_log_appender"),i=c("./utils"),j=c("config"),k=c("async"),l=i.monitor,m="v",n="a",o="g",p="s",q="a",r=null,s=!1;l.on("store",function(a){return s&&"new"===a?r&&r.publishExt():void 0}),l.on("time",function(a){return"synced"===a?(s=!0,r&&r.publishExt()):void 0}),a.exports.init=function(b,c,i,m,n,o){v(i);var p={clientId:i,keepalive:Number(j.Gateway.reportInterval,10)/1e3*2,clean:!0,autopuback:!1,logger:d,will:{topic:t.mqttStatus,payload:"err",retain:!0}};d.info("[mqtt-init] opts",p),p.store=n,!o&&m&&"function"==typeof m&&(o=m,m=null),j.Server&&j.Server.mqtt&&(p.retryConnectInterval=j.Server.mqtt.retryConnectInterval,p.ackTimeout=j.Server.mqtt.ackTimeout);try{r=m?new e(b,c,g._extend(p,m)):new e(b,c,p)}catch(q){return o&&o(q)}return r?(r.on("connect",function(){try{r.subscribe([t.rpcRequest,t.logFilter],{qos:1},function(a,b){a?d.error("subscribe:"," err=",a):d.info("subscribe:"," granted=",b)})}catch(a){return d.error("mqtt init() fail / exception=",a),r.client.end()}try{r.publish(t.mqttStatus,"on",{qos:1,retain:!0}),l.emit("mqtt","connected"),d.info("mqtt CONNECTED")}catch(a){d.error("mqtt init() fail / exception2=",a)}}),r.on("close",function(){l.emit("mqtt","closed"),d.warn("mqtt close")}),r.on("error",function(a){l.emit("mqtt","error"),d.error("mqtt error",a)}),r.on("message",function(b,c,e,g){var i,j,m;if(d.debug("mqtt messages",b,c,e),b===t.rpcRequest){try{i=JSON.parse(c)}catch(l){}if(!i)return d.error("unknown Rpc message",c),g&&g();i&&i.params&&i.params.aws?(j=i.params.aws,delete i.params.aws,d.info("gatewayRpc:",i),i.params.aws=j):d.info("gatewayRpc:",i),k.series([function(b){if(f.checkRestart(i.cmd)){var c=setTimeout(function(){return c=null,b()},1e4),e={uid:i.uid,result:{stdout:"requireResart"}};a.exports.publish(t.rpcResponse,JSON.stringify(e),{qos:1,retain:!1},function(){c?(d.info("[gatewayRpc] requireRestart sent"),clearTimeout(c),b()):d.error("[gatewayRpc] restart puback took 10secs")})}else b()},function(a){f.process(i.cmd,i.params,function(b,c){var e;b?(d.error("remocon.process:",b),e={uid:i.uid,result:""+b}):(d.info("remocon.process done",i),e={uid:i.uid,result:c||""}),r.publish(t.rpcResponse,JSON.stringify(e),{qos:1,retain:!1}),a(b)})}],function(){return g&&g()})}else{if(b!==b.logFilter)return d.error("remocon unknown topic",b),g&&g();try{m=JSON.parse(c)}catch(l){"string"==typeof c&&(m=c)}m&&h.setLevelFilter(m)}}),o&&o()):o&&o(Error("mqtt.init failure"))},a.exports.publish=function(a,b,c,e){return d.info("sent(direct) [%s] : %s",a,b),"function"==typeof c&&(e=c,c=void 0),r&&r.publish(a,b,c||{qos:1,retain:!1},e)},a.exports.getStatus=function(){var a=r&&r.getStatus();return a},a.exports.log=function(a){r&&u&&r.publish(t.log,JSON.stringify(a),{qos:1,retain:!1})}}),c.register("./mqttHelper.js",function(a,b,c){"use strict";function n(a,b,c){if(!a||!b)throw Error("port and host are required");c||(c={}),this.port=a,this.host=b,this.opts=c,this.secure=c&&c.pfxPath?!0:!1,this.client=null,this.ackTimer=null,this.store=c.store,this.status={connected:!1,lastSentTime:null},c.reconnectPeriod=0,c.retryConnectInterval=c.retryConnectInterval||k,c.ackTimeout=c.ackTimeout||l;var f=this;!function g(){var a;d.debug("MH.init()"),f.reinitTimer=null,f.client||(f.status.connected=!1,f.client=a=!0===f.secure?e.createSecureClient(f.port,f.host,f.opts):e.createClient(f.port,f.host,f.opts),d.info("MH CREATE secure("+(f.secure?"yes":"no")+") "+f.host+":"+f.port),f.ackTimer=setTimeout(function(){f.status.connected=!1,d.warn("[mqtt.init] MH.ackTimer out : try disconnect"),f.ackTimer=null,f.client&&(f.client.destroy(),f.client=null)},f.opts.ackTimeout),a.on("message",f.emit.bind(f,"message")),a.on("connect",function(){f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.emit("connect"),f.status.connected=!0,f.publishExt()}),a.on("close",function(){return f.status.connected=!1,f.client&&(f.client.destroy(),f.client=null),f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.reinitTimer?void f.emit("close"):(f.reinitTimer=setTimeout(g.bind(f),f.opts.retryConnectInterval),void f.emit("close"))}),a.on("error",function(){return f.status.connected=!1,f.client&&(f.client.destroy(),f.client=null),f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.reinitTimer?void f.emit("error"):(f.reinitTimer=setTimeout(g.bind(f),f.opts.retryConnectInterval),void f.emit("error"))}))}()}var h,j,k,l,m,d=c("log4js").getLogger("MQTT"),e=c("mqtt"),f=c("events"),g=c("util");try{h=c("compress-buffer").compress}catch(i){d.warn("MODULES_NOT_SUPPORTED - compress-buffer")}j={qos:1,retain:!1},k=6e4,l=3e4,m=100,g.inherits(n,f.EventEmitter),n.prototype.publishExt=function(){var b,c,a=this;this.client&&0!==this.store.size()&&(this.ackTimer||(this.store.getFirst(function(c,d){b=a.store.encode(d),b&&(b.seq=c)}),b&&(this.ackTimer=setTimeout(function(){a.status.connected=!1,d.warn("MH.ackTimer out : try disconnect"),a.ackTimer=null,a.client&&(a.client.destroy(),a.client=null)},this.opts.ackTimeout),d.info("MH SENDING ("+b.seq+") "+b.topic+" : "+(b.message.length>100?b.message.substr(0,100)+" ...":b.message)),c=h&&b.message&&b.message.length>m?h(new Buffer(b.message)):b.message,this.client.publish(b.topic,c,j,function(c){a.status.connected=!0,a.status.lastSentTime=Date.now(),c&&d.error("MH.publish/callback error",c),a.ackTimer&&(clearTimeout(a.ackTimer),a.ackTimer=null),d.info("MH SENT    ("+b.seq+") "+b.topic+" : "+(b.message.length>100?b.message.substr(0,100)+" ...":b.message)),a.store.rm(b.seq),process.nextTick(a.publishExt.bind(a))}))))},n.prototype.publish=function(){this.client?this.client.publish.apply(this.client,arguments):d.error("MH.publish fail")},n.prototype.subscribe=function(){this.client?this.client.subscribe.apply(this.client,arguments):d.error("MH.subscribe fail")},n.prototype.getStatus=function(){return this.status},a.exports=n}),c.register("./mqtt_log_appender.js",function(a,b,c){"use strict";function j(a){a&&("string"==typeof a?i=f.toLevel(a,i):(i={},g.each(a,function(a,b){i[b]=f.toLevel(a)})))}function k(a){return a&&j(a),function(a){var b=a.categoryName;a.level.isGreaterThanOrEqualTo(i[b]||i)&&h.log({l:a.level.levelStr.charAt(0),c:b,t:Date.parse(a.startTime),d:e.messagePassThroughLayout(a)})}}function l(a){var b=a&&a.level;return k(b)}var d=c("log4js"),e=d.layouts,f=d.levels,g=c("lodash"),h=c("./mqtt"),i=f.FATAL;b.appender=k,b.configure=l,b.setLevelFilter=j}),c.register("./remotecontroller.js",function(a,b,c){"use strict";function t(a,b){m(a,{encoding:"utf8",timeout:12e4,maxBuffer:512e3,killSignal:"SIGKILL",cwd:__dirname,env:null},function(c,d,e){return c&&l.error(a,c),e&&l.error(a,e),b&&b(null,{err:c||void 0,stdout:d,stderr:e||void 0})})}var u,v,d=c("os"),e=c("async"),f=c("lodash"),g=c("fs"),h=c("path"),i=c("crontab"),j=c("config"),k=c("ini"),l=c("log4js").getLogger("Main"),m=c("child_process").exec,n=c("./utils"),o=n.monitor,p="/etc/wvdial.conf",q="Dialer Defaults",r={Username:"",Password:"",Enable:!1,"Stupid mode":"yes"},s={};f.each(["forever","git","wvdial","wvdialconf"],function(a){m("which "+a,function(b){s[a]=!b})}),u={controlActuator:function(a,b,c){o.emit("actuator","command",b,c)},timeSync:function(a,b,c){if(!(b&&b.time&&f.isNumber(b.time)&&n.isValidTime(b.time)))return l.error("invalid timesync req"),c&&c(Error("invalid time"));var d=b.time/1e3;return n.isValidTime()?(l.info("time sync already"),c&&c()):(l.warn("time sync @"+d),void t("date -s @"+d+"; service ntp restart",c))},poweroff:function(a,b,c){return t("poweroff &"),c&&c()},reboot:function(a,b,c){return t("sync; sleep 5; sync; reboot &"),c&&c()},resetConfig:function(a,b,c){t("rm -f "+h.join(__dirname,"config","runtime.json"),function(){return t(s.forever?"forever restart device &":"sh ./update/restart.sh &"),c&&c()})},rebootEveryday:function(a,b,c){i.load(function(a,d){if(a)return c&&c(a);var i,e=b&&b.cmd,g=b&&parseInt(b.hourAt,10),h=b&&parseInt(b.minAt,10);return e?(d.remove(d.findCommand(e)),f.isNumber(g)?(i=d.create(e),i.hour().on(g),i.minute().on(h||0),void d.save(function(a){return a?c&&c(Error("cron save error="+a)):c&&c()})):c&&c()):c&&c(Error("invalid params="+JSON.stringify(b)))})},restart:function(a,b,c){return t(s.forever?"forever restart device &":"sh ./update/restart.sh &"),c&&c()},swUpdate:function(a,b,c){return t("cd "+__dirname+"; sh ./update/update.sh &"),c&&c()},shell:function(a,b,c){return b&&b.cmd?void t(b.cmd,c):c&&c(Error("null cmd"))},modem:function(a,b,c){var h,i,d={};return!b||!b.cmd||"getModemConfig"!==b.cmd&&"setModemConfig"!==b.cmd?c&&c(Error("invalid params="+b)):"setModemConfig"!==b.cmd||b.config&&b.modem?s.wvdial?(i=!1,void e.series([function(a){m("/etc/init.d/wvdial.sh status",function(b){return b||(i=!0),a()})},function(a){return"getModemConfig"!==b.cmd&&i?void m("/etc/init.d/wvdial.sh stop",function(){return i=!1,a()}):a()},function(a){if(i)return a();var c="getModemConfig"===b.cmd?"/dev/null":p;m("wvdialconf "+c,function(b){return b?a("MODEM, not found"):a()})},function(a){try{h=k.parse(g.readFileSync(p,"utf-8"))}catch(b){l.error("wvdialConf parse",b)}return h&&h[q]?a():a(Error("wvdial conf not found"))}],function(a){if(a)return l.error(b.cmd,"err",a),c&&c(a);var e=h[q];return"setModemConfig"===b.cmd&&(j.Modem=b.config,e.Phone="*99#",(f.isUndefined(e.Baud)||f.isNaN(+e.Baud)||+e.Baud<115200)&&(e.Baud=115200),f.defaults(e,r),e.Username=b.config.APN_USER,e.Password=b.config.APN_PASS,e.Init3='AT+CGDCONT=1, "IP", "'+b.config.APN+'"',e.Enable=!!b.config.ENABLED,g.writeFileSync(p,k.stringify(h)),e.Enable?m("/etc/init.d/wvdial.sh restart",function(a,b,c){l.info("wvdial restart",a,b,c)}):m("/etc/init.d/wvdial.sh stop",function(a,b,c){l.info("wvdial stop",a,b,c)}),l.info("setModemConfig",e)),d.config=j.Modem,d.modem=e.Modem,d.modemType=e["Modem Type"],c&&c(null,[d])})):c&&c(Error("modem scanner is not available")):c&&c(Error("setModemConfig requires params.config and modemId"))},netInfo:function(a,b,c){var k,n,g=["lo","usb"],h=b&&b.ifName,i=[],j=[],l=d.networkInterfaces();return f.isEmpty(l)||h&&!l[h]?c&&c(Error("not found ???")):(h&&(n=l[h],l={},l[h]=n),f.each(l,function(a,b){var c=f.where(a,{family:"IPv4"});f.any(g,function(a){return 0===b.indexOf(a)})||f.isEmpty(c)||(i.push(b),j.push(c[0]))}),k=f.zipObject(i,j),void e.eachSeries(i,function(a,b){m("ifconfig "+a,function(c,d){if(d){var e=d.match(/RX\ bytes:(\d+).*TX\ bytes:(\d+)/);k[a].RxBytes=e[1],k[a].TxBytes=e[2]}b()})},function(){var a=[];return f.each(k,function(b,c){a.push(f.extend({id:c},b))}),f.isEmpty(a)?c&&c("not found"):h?c&&c(null,a[0]):c&&c(null,a)}))},swInfo:function(a,b,c){var d,e={local:{},remote:{}};d="cd "+__dirname+"; sh ./update/version.sh",m(d,function(a,b,g){var i,j,h={};return i=b&&b.split("\n"),l.debug(b,i),f.each(i,function(a){var b=/^@@(\w+)/.exec(a);b?(j=b[1],h[j]={lines:[]}):h[j].lines.push(a)}),f.isEmpty(h)?l.error("cmd=",d,"err=",a,"stdout=",b,"stderr=",g):f.each(e,function(a,b){h[b]&&h[b].lines&&(e[b]={version:h[b].lines[0],date:h[b].lines[1],comment:h[b].lines[2]})}),c&&"function"==typeof c?c(null,e):void 0})}},v={controlActuator:{proc:u.controlActuator,restart:!1},timeSync:{proc:u.timeSync,restart:!1},poweroff:{proc:u.poweroff,restart:!0},reboot:{proc:u.reboot,restart:!0},resetConfig:{proc:u.resetConfig,restart:!0},rebootEveryday:{proc:u.rebootEveryday,restart:!1},restart:{proc:u.restart,restart:!0},swUpdate:{proc:u.swUpdate,restart:!0},shell:{proc:u.shell,restart:!1},modem:{proc:u.modem,restart:!1},netInfo:{proc:u.netInfo,restart:!1},swInfo:{proc:u.swInfo,restart:!1}},a.exports.process=function(a,b,c){var d=v[a].proc;return d?void d(a,b,c):(l.info("[RMCTRL] unknown cmd:",a),c&&c(Error("unknown command:"+a)))},a.exports.checkRestart=function(a){return v[a]&&v[a].restart?!0:!1}}),c.register("./routes.js",function(a,b,c){"use strict";var d=c("log4js").getLogger("Main"),e=c("lodash"),f=c("config"),g=c("fs"),h=c("./gateway"),i=c("./remotecontroller"),j=c("./server"),k=c("./sensors");a.exports.gatewayInfo=function(){return function(a,b){h.sync(function(){b.send(JSON.stringify(h))})}},a.exports.gatewayConfig=function(){return function(a,b){var c=a.body;h.putItem(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}},a.exports.gatewayControl=function(){return function(a,b){var c=a.query.command,f=["poweroff","reboot","restart","swUpdate","resetConfig"];return c&&e.contains(f,c)?(d.info("[HTTPAPI] gatwayControl",c),void i.process(c,null,function(a,e){d.info("[HTTPAPI] gatwayControl",c,a||e),a?b.send(404,"command failure"+a):b.send(e)})):b.send(400,"bad request: invalid param")}},a.exports.serverInfo=function(){return function(a,b){j.statusUpdate(function(){var a=["config","status","registered"],c={};e.each(a,function(a){c[a]=j[a]}),d.info("[HTTPAPI] /api/server/info",JSON.stringify(c,null,2)),b.send(c)})}},a.exports.softwareInfo=function(){return function(a,b){i.process("swInfo",null,function(a,c){d.info("[HTTPAPI] /api/software/info",a||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.sensorData=function(){return function(a,b){d.info("[HTTPAPI] /api/sensor/data",JSON.stringify(k.sensorsData)),b.send(JSON.stringify(k.sensorsData))}},a.exports.sensorDiscover=function(){return function(a,b){var c=a.query.driverName;k.discover(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}},a.exports.getSensorItem=function(){return function(a,b){var d,c=a.params.id;return c?(d={driverName:a.query.driverName,model:a.query.model,network:a.query.network,address:a.query.address},void k.getItem(c,d,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})):b.send(400,"empty sensorId")}},a.exports.delSensorItem=function(){return function(a,b){var c=a.params.id;return c?void k.delItem(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)}):b.send(400,"empty sensorId")}},a.exports.postSensorItem=function(){return function(a,b){var d,c=a.body.id;return c?(d=a.body,d.reqId=c,delete d.id,d.series="sensor"===a.body.category?c:null,d.owner=h.id,d.ctime=Date.now(),void k.postItem(d,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})):b.send(400,"empty sensorId")}},a.exports.certUpload=function(){return function(a,b){var c=a.files.cert;b.setHeader("Content-Type","text/html"),j.postCert(c,function(a,c){b.send(a?{statusCode:a.statusCode,msg:""+a}:{statusCode:200,msg:c})})}},a.exports.getInterfaces=function(){return function(a,b){i.process("netInfo",null,function(a,c){d.info("[HTTPAPI] getInterfaces netInfo",a||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.getInterfaceItem=function(){return function(a,b){var c=a.params.id;return c?void i.process("netInfo",{ifName:c},function(a,e){d.info("[HTTPAPI] getInterface netInfo",c,a||e),a?b.send(404,"not found"):b.send(e)}):b.send(400,"empty id")}},a.exports.getModems=function(){return function(a,b){i.process("modem",{cmd:"getModemConfig"},function(a,c){d.info("[HTTPAPI] getInterface modem, getModemConfig",a&&a.message||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.getModemItem=function(){return function(a,b){var c=a.params.id&&decodeURIComponent(a.params.id);i.process("modem",{cmd:"getModemConfig",modem:c},function(a,e){d.info("[HTTPAPI] getInterface modem, getModemConfig",c,a||e),a||!e||0===e.length?b.send(404,"not found"):b.send(e[0])})}},a.exports.putModemItem=function(){return function(a,b){var c=a.params.id&&decodeURIComponent(a.params.id),e=a.body;i.process("modem",{cmd:"setModemConfig",modem:c,config:e},function(a,e){d.info("[HTTPAPI] getInterface modem, setModemConfig",c,a||e),a||!e||0===e.length?b.send(400,"err="+a):b.send(e[0])})}},a.exports.chPasswd=function(){return function(a,b){var c=a.body.currentPassword,d=a.body.newPassword;c&&d&&f.Auth.admin===c?(f.Auth.admin=d,b.end()):b.send(400,"password mismatch or missing new password")}},a.exports.getModemStats=function(){return function(a,b){var c="/run/umtskeeper/umtskeeper.stat";g.readFile(c,function(a,c){var e,f={},g={};a&&d.error("[ModemStats]",a),e=["rxBDays","rxBDaysLastMonth","rxBHrs","rxBHrsAcc","rxBHrsYesday","rxBMonth","rxBQHrs","rxBQHrsAcc","rxBQHrsYesday","rxBToday","rxBTot","rxBYesday","txBDays","txBDaysLastMonth","txBHrs","txBHrsAcc","txBHrsYesday","txBMonth","txBQHrs","txBQHrsAcc","txBQHrsYesday","txBToday","txBTot","txBYesday"],e.forEach(function(a){var b=RegExp(a+"':\\s(.*),\\s\\\\");f[a]=(""+c).match(b)[1]}),d.info("[ModemStats] Stats",f),g.stats=f,g.gateway=h,a||!f?b.send(404,"not found"):b.send(g)})}},a.exports.controlActuator=function(){return function(a,b){var c,d;c=a.body,d=a.body.options,k.controlActuator(c,d,function(a,c){a?(b.writeHead(a.statusCode||400),b.end(a&&""+a)):b.send(c)})}},a.exports.getSensorDrivers=function(){return function(a,b){j.getSensorDrivers(function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}}}),c.register("./sensors.js",function(a,b,c){"use strict";function G(a){var b,c,f,h,i,j,m,s,t,u;if(!(a&&a.id&&k.sensors&&k.sensors[a.id]))return void d.warn("invalid sensor data or, sensor  no longer exit",a);if(b=k.reportInterval/1e3*1.5,c=a.status,f=a.id,h=k.sensors[f].type,i=a.result?a.result[h]:null,r.emit("sensor","active"),s=F.sensorsData[f].status,"off"===c)F.sensorsData[f].status=A,d.warn("OFF from driver","index=",F.sensorsData[f],"id=",f);else if("error"===c)F.sensorsData[f].status=B,d.warn("Can not get data from sensor",a.message,"index=",F.sensorsData[f],"id=",f);else{if("ok"!==c)return void d.error("Unexpected result code",c,"id=",f);if(d.debug(f+" => "+i),null===i||void 0===i)return F.sensorsData[f].status=z,void d.info("sensorDataHandler: no value, status(ok) only","id=",f);t=Date.now(),u={v:i,u:parseInt(1e3*g.uptime(),10)},o.isValidTime(t)&&(u.t=t),F.sensorsData[f].latest=u,F.sensorsData[f].values.push(u),F.sensorsData[f].status=z,F.sensorsData[f].type=h,n.getSensorProperties(e.Sensors[f].model).onChange&&(q.push({topic:p.topic.getSensor(f),message:F.sensorsData[f].values}),F.sensorsData[f].values=[])}m=F.sensorsData[f].status,s!==m&&(j=m===z?b:-1,d.info("[%s] sensor status: %s -> %s",f,s,m),l.isConnected("mqtt")?p.publish(p.topic.getSensorStatus(f),""+[m,j]):d.warn("sensor status: NOT SENT due to mqtt unavailable"))}function H(a){d.info("sensorChangeHandler() currentData=",a),G(a)}function I(a,b){var c,e,f,g,h,i,j;return b&&b.model&&(e=n.getSensorProperties(b.model)),e?(g="sensorjs",h=b.network||e.supportedNetworks[0],i=e.addressable?b.address:b.address||a,j=b.model,f=g+"://"+["",h,i,j,a].join("/"),c=n.createSensor(f),d.info("sensorUrl",f),c):(d.error("sensor properties are necessary",b),null)}var s,t,u,v,x,y,z,A,B,C,D,E,F,d=c("log4js").getLogger("Sensors"),e=c("config"),f=c("util"),g=c("os"),i=(c("url"),c("lodash")),j=c("async"),k=c("./gateway"),l=c("./server"),m=c("sensorjs"),n=m.sensor,o=c("./utils"),p=c("./mqtt"),q=c("./store"),r=o.monitor;try{s=c("sensorjs-futuretek"),n.addSensorPackage(s)}catch(w){d.warn("MODULES_NOT_SUPPORTED - sensorjs-futuretek")}try{t=c("sensorjs-ble"),n.addSensorPackage(t)}catch(w){d.warn("MODULES_NOT_SUPPORTED - bleSensor")}try{u=c("sensorjs-foscam"),n.addSensorPackage(u)}catch(w){d.warn("MODULES_NOT_SUPPORTED - sensorjs-foscam")}try{v=c("aws-sdk")}catch(w){d.warn("MODULES_NOT_SUPPORTED - aws-sdk")}x=5e3,y=Number(e.Gateway&&e.Gateway.firstDelay,10)||x,z="on",A="off",B="err",C=6e4,D=o.statusError,E=!1,F=a.exports={sensors:{},sensorsData:{}},r.on("mqtt",function(a){E&&"connected"===a&&F.mqttPublishAll()}),F._newSensor=function(a,b){var c,e,f;F.sensors[a]&&(d.warn("remove before adding sensor",a),F._removeSensor(a)),c={model:b.model,macAddress:k.id},b&&b.model&&(e=n.getSensorProperties(b.model)),f=I(a,b),"actuator"===b.category?F.sensors[a]=f:e&&f?(F.sensorsData[a]={values:[],latest:null,_time:null,firstDelay:y,status:null,interval:e.recommendedInterval||C},d.info("newSensor:",a,c),e.onChange?(f.on("change",H),f.listen("change")):(f.on("data",G),f.listen(c.retriveInterval)),F.sensors[a]=f):d.error("newSensor failure / driverName=",b.driverName,"sensorId=",a,"options=",c)},F.newSensor=function(a,b){e.Sensors[a]=b,e.Sensors=f._extend({},e.Sensors),k.sensors=e.Sensors,F._newSensor(a,b)},F.updateSensor=function(a,b){e.Sensors[a]=b,e.Sensors=f._extend({},e.Sensors),k.sensors=e.Sensors},F._removeSensor=function(a){var b=F.sensors[a];b&&(b.clear&&(b.clear(),d.info("sensor is cleared",a)),b.removeListener("data",G),b.removeListener("change",H),delete F.sensors[a],i.has(F.sensorsData,a)&&delete F.sensorsData[a])},F.removeSensor=function(a){d.info("removeSensor:",a),e.Sensors[a]&&(delete e.Sensors[a],e.Sensors=f._extend({},e.Sensors),k.sensors=e.Sensors),F._removeSensor(a)},F.discover=function(a,b){var c,e=[],f=[],g=n.getSensorProperties(a);return g&&g.discoverable?void n.discover(a,function(a,g){return d.info("discovered devices info",g),a?void d.error("err=",a.stack):g.length>0?(i.each(g,function(a){i.each(a.sensorUrls,function(a){e.push(n.parseSensorUrl(a))})}),i.each(k.sensors,function(a,b){for(var c=e.length-1;c>=0;c--)e[c].id===b&&(e.splice(c,1),f.push(b))}),d.info("[HTTPAPI] /api/discover - founds",e),c={"new":e,registered:f},b&&b(null,c)):b&&b(D(404,"not found"))
}):b&&b(D(404,"not discoverable"))},F.getItem=function(a,b,c){var g,h,i,e=b.model,f={model:e,macAddress:k.id};return a&&e?(d.info("[HTTPAPI] GET /api/sensors/:id sensorId=",a,"model=",e,"options=",f),b&&b.model&&(g=n.getSensorProperties(b.model)),(h=I(a,b))?(i=setTimeout(function(){return d.info("[HTTPAPI] GET /api/sensors/:id, timeout",1.5*g.recommendedInterval),h=null,c&&c(D(404,"not found"))},1.5*g.recommendedInterval),h.once("data",function(a){return clearTimeout(i),h?(d.info("[HTTPAPI] GET /api/sensors/:id, sent response and sensor is deleted"),h=null,c&&c(null,a)):void 0}),void h.listen(0)):(d.warn("createSensor() failure / model=",e,"sensorId=",a,"options=",f),c&&c(D(404,"not found in local sensor list")))):c&&c(D(400,"Sensor ID and model are required"))},F.delItem=function(a,b){l.delSensor(a,function(c){return c?b&&b(D(400,"failure to delete sensor="+a)):(F.removeSensor(a),b&&b(null,JSON.stringify(k)))})},F.postItem=function(a,b){var c=a.reqId;return d.info("postItem - sensorId",c),l.isConnected()?void l.upsertSensor(c,a,function(e){return e?b&&b(e):(k.sensors[c]?(d.warn("postItem: already exist",k.sensors[c]),F.updateSensor(c,a),d.info("postItem - sensor info is updated")):(F.newSensor(c,a),d.info("postItem - new sensor is added")),b&&b(null,JSON.stringify(k.sensors)))}):b&&b(D(403,"registration is required or not connected"))},F.controlActuator=function(a,b,c){var g,e=a.id,f=a.aws;if(delete a.aws,i.has(F.sensors,e))g=F.sensors[e],d.info("[sensors] actuator is existing",e);else{if(!a.id||!a.model)return c&&c(D(400,"Sensor ID and model are required"));if(d.info("[HTTPAPI] POST /api/actuator/control sensorInfo=",a),g=I(e,a),setTimeout(function(){g.clear(),g=null},5e3),!g)return d.warn("controlActuator() failure/ sensorInfo=",a),c&&c(D(404,"not found in local sensor list"))}g.set(a.cmd,b,function(a,b){var e,g,h=b;if(!i.isObject(b))return c&&c(a,h);if(b.returnResult&&(h=b.returnResult),d.info("[sensors/controlActuator] return result",h),b.upload){if(d.info("[sensors/controlActuator] upload"),v&&f&&f.config&&f.upload)return g=f.upload,v.config.update(f.config),e=new v.S3,g.Body=b.upload.content,g.ContentType=b.upload.contentType,void e.putObject(g,function(a){return a?d.error("[sensors/controlActuator] upload err",a):(d.info("[sensors/controlActuator] Successfully uploaded"),h.uploaded=!0,delete h.content),c&&c(a,h)});d.error("controlActuator() upload failure / no aws info")}return c&&c(a,h)})},F.mqttPublishAll=function(){var b,c,a=(k.reportInterval||6e4)/1e3*1.5;l.isConnected("mqtt")&&r.emit("mqtt","active"),b=l.timeSynced?{status:z,duration:a,sensors:[]}:{status:B,duration:-1,sensors:[]},i.each(F.sensorsData,function(c,d){var e=c.status;e===z&&c.values.length>0&&(q.push({topic:p.topic.getSensor(d),message:c.values}),c.values=[]),b.sensors.push({id:d,status:e||A,duration:e===z?a:-1})}),i.each(i.where(k.sensors,{category:"actuator"}),function(c){var e,d=c.id;if(!b.sensors[d]){try{e=F.sensors&&F.sensors[d]&&F.sensors[d].getStatus()}catch(f){}b.sensors.push({id:d,status:e||A,duration:e===z?a:-1})}}),d.info("[%s] status",k.id,b),c=[b.status,b.duration],c=c.concat(i.zip(i.pluck(b.sensors,"id"),i.pluck(b.sensors,"status"),i.pluck(b.sensors,"duration"))),l.isConnected("mqtt")?p.publish(p.topic.status,""+c):d.warn("Gateway status: NOT SENT due to unavailable mqtt")},F.init=function(a){return E?a&&a():(E=!0,i.each(k.sensors,function(a,b){F._newSensor(b,a)}),k.model&&k.deviceModels&&j.waterfall([function(a){l.getSensorDrivers(function(b,c){return b?a(b):a(null,c)})},function(a,b){l.getGatewayModels(function(c,d){return c?b(c):b(null,a,d)})},function(a,b,c){var e=i.find(b,{id:k.model}),f=i.pluck(k.sensors,"id");if(!k.deviceModels)return c();if("string"==typeof k.deviceModels){d.info("[sensors/init] string type",k.deviceModels);try{k.deviceModels=JSON.parse(k.deviceModels)}catch(g){return d.info("[sensors/init] JSON parse error",k.deviceModels),c()}}j.eachSeries(k.deviceModels,function(b,c){var g=i.find(e.deviceModels,{id:b.model});g&&g.sensors?j.eachSeries(g.sensors,function(c,e){var g=i.find(a,{id:c.driverName});return g.discoverable?void F.discover(c.driverName,function(a,h){return a?e():0===h.new.length?e():void i.forEach(h.new,function(a){var j,h=a.id;if(i.contains(f,h))return!0;if(c.model&&c.model!==a.model||c.network!==a.device.sensorNetwork)return!0;if(j=i.clone(c,!0),j.reqId=h,j.name=c.type+"_"+h,j.owner=k.id,j.ctime=Date.now(),j.series=h,j.address=a.device.address,g.commands&&(j.commands=g.commands),a.device.id&&a.device.id===b.id)j.deviceId=a.device.id;else{if(a.device.id&&b.id&&a.device.id!==b.id)return e(),!1;j.deviceId=!a.device.id&&b.id?b.id:h}F.postItem(j,function(a,b){return a?d.error("[sensors] init - error with Sensors.postItem",a):(d.info("[sensors] init - success with Sensors.postItem",b),f.push(h)),e(a)})})}):e()},function(a){return a?(d.error("[sensors] init - adding unregistered sensors error - deviceModel.sensors",a),c(a)):c()}):(d.warn("[sensors/init] - No Device model",b.model),c())},function(a){return a?(d.error("[sensors] init - adding unregistered sensors error - Gateway.deviceModels",a),c(a)):c()})}],function(a,b){a?d.error("[sensors] init - adding unregistered sensors error",a):d.info("[sensors] init done",b)}),d.warn("... Start gathering data - REPORT_INTERVAL(%s) ...",k.reportInterval),setTimeout(function(){setInterval(F.mqttPublishAll,k.reportInterval)},y+5e3),a&&a())}}),c.register("./server.js",function(a,b,c){"use strict";var g,h,i,j,k,l,m,n,o,p,q,r,s,d=c("log4js").getLogger("Server"),e=c("config"),f=c("lodash");e=c("config"),g=c("http"),h=c("fs"),i=c("async"),j=c("request"),k=c("querystring"),l=c("./utils"),m=c("./remotecontroller"),n=c("./store"),o=c("./mqtt"),p=l.statusError,q=l.monitor,r=e.Server&&e.Server.timeSyncCheckInterval||6e4,s=a.exports={config:{mqtt:e.Server.mqtt,service:e.Server.service},requestOptions:{json:!0,timeout:6e4},status:{mqtt:{connected:!1,lastError:""},service:{connected:!1,lastError:""}},baseUrl:null,gatewayUrl:null,gatewayId:null,registered:!1,timeSynced:!1},q.on("mqtt",function(a){switch(a){case"connected":s.status.mqtt.connected=!0;break;case"close":case"error":s.status.mqtt.connected=!1}}),s.isConnected=function(a){return"mqtt"===a?this.status.mqtt.connected:this.registered&&this.status.service.connected},s.init=function(a,b){s.registered=!0,"https"===e.Server.service.protocol?h.existsSync(e.Gateway.CERT_FILE_PATH)?(s.requestOptions.pfx=h.readFileSync(e.Gateway.CERT_FILE_PATH),s.requestOptions.rejectUnauthorized=!0,s.requestOptions.passphrase=a):s.registered=!1:"http"===e.Server.service.protocol&&(s.requestOptions.headers={gateway:a}),s.gatewayId=a,s.baseUrl=e.Server.service.protocol+"://"+e.Server.service.host+("80"===e.Server.service.port?"":":"+e.Server.service.port),s.gatewayUrl=s.baseUrl+"/api/gateways/"+a,s.timeSynced=!1,function c(){l.isValidTime()?(n.timeSync(),s.timeSynced=!0,q.emit("time","synced")):setTimeout(c,r)}(),s.timeSynced||d.warn("time: NOT IN SYNC"),s.statusUpdate(function(a){return a&&d.warn("error Sever.update on init",a),b&&b()})},s._getGateway=function(a,b){var c=s.gatewayUrl;a&&(c+="?"+k.stringify(a)),j.get(c,f.clone(s.requestOptions),function(a,c,d){return a?b&&b(a):2!==Math.floor(c.statusCode/100)?b&&b(p(c.statusCode)):b&&b(null,d)})},s.getGateway=function(a,b){return s.isConnected()?s._getGateway(a,b):b&&b(p(403,"registration is required or not connected"))},s.putGateway=function(a,b){var c,e={};return s.isConnected()?(d.info("putGateway ",a),a.reportInterval&&(c=Number(a.reportInterval,10),delete a.reportInterval),void i.series([function(b){return f.isEmpty(a)?b():void j.put(s.gatewayUrl,f.extend({body:a},s.requestOptions),function(a,c,f){return a||2!==Math.floor(c.statusCode/100)?(d.error("putGateway err=",a||p(c.statusCode)),b(a||p(c.statusCode))):(e=f,void b())})},function(a){return f.isNull(c)||f.isUndefined(c)?a():void j.post(s.baseUrl+"/api/manageGateway",f.extend({body:{id:s.gatewayId,act:"setProperty",params:{reportInterval:c}}},s.requestOptions),function(b,f){return b||2!==Math.floor(f.statusCode/100)?(d.error("manageGateway err=",b||f.statusCode),a(b||p(f.statusCode))):(e||(e={}),e.reportInterval=c,void a(null))})}],function(a){return a?d.error("putGateway result err=",a):d.info("putGateway result",e),b&&b(a,e)})):b&&b(p(403,"registration is required or not connected"))},s.statusUpdate=function(a){var b=this;return s.registered?void i.forEachSeries(Object.keys(this.config),function(a,c){var f,e=b.config[a];return 0===e.protocol.indexOf("mqtt")?(f=o&&o.getStatus(),s.status[a].connected=f&&f.connected||!1,c()):0!==e.protocol.indexOf("http")?(d.error("Unknown Server"),c()):void s._getGateway(null,function(b,d){var e;if(b){if(s.status[a].connected=!1,b.statusCode)e="Gateway - "+g.STATUS_CODES[b.statusCode];else switch(b.message){case"mac verify failure":e="Certificate is not for this gateway";break;default:e=""+b}s.status[a].lastError=e}else d&&(s.status[a].connected=!0);return c()})},function(c){return f.each(b.config,function(a,b){d.info("[%s] - %s",b,s.status&&s.status[b].connected?"CONNECTED":"DISCONNECTED")}),a&&a(c)}):a(Error("need registration"))},s.upsertSensor=function(a,b,c){i.series([function(c){b.reqId||(b.reqId=a),j.post(s.gatewayUrl+"/sensors",f.extend({body:b},s.requestOptions),function(e,g,h){if(e||409!==g.statusCode){if(e||2!==Math.floor(g.statusCode/100))return d.error("post Sensor failure",a,e||g.statusCode),c(e);d.debug("upsert sensor",h),c()}else delete b.reqId,j.put(s.gatewayUrl+"/sensors/"+a,f.extend({body:b},s.requestOptions),function(b,e,f){return b||2!==Math.floor(e.statusCode/100)?(d.error("put Sensor failure",a,b||e.statusCode),c(b||p(e.statusCode))):(d.debug("upsert sensor",f),c())})})},function(b){s.getGateway(null,function(e,g){if(e)return d.error("gateway get",e),c&&b(e);var h=g.sensors;h=f.pull(f.uniq(h),"null","undefined",null,void 0),f.contains(h,a)||h.push(a),s.putGateway({sensors:h},function(a,c){return a&&d.error("gateway sensorlist update failure",a),b(a,c)})})}],function(a){return a&&d.error("upsert sensor",a),c&&c(a)})},s.delSensor=function(a,b){return s.isConnected()?void i.series([function(b){j.del(s.gatewayUrl+"/sensors/"+a,f.clone(s.requestOptions),function(c,e){return c||2!==Math.floor(e.statusCode/100)?(d.error("del Sensor failure",c||e.statusCode),b(c)):(d.info("del sensor",a),b())})},function(c){s.getGateway(null,function(e,g){if(e)return d.error("gateway get",e),b&&c(e);var h=g.sensors;h=f.pull(f.uniq(h),"null","undefined",null,void 0),f.pull(h,a),s.putGateway({sensors:h},function(a,b){return a&&d.error("gateway sensorlist update failure",a),c(a,b)})})}],function(a,c){return a&&d.error("del sensor",a),b&&b(a,f.last(c))}):b&&b(p(403,"registration is required or not connected"))},s.postCert=function(a,b){var f,c=a.path;if(a.size<=0)return f="No Cert",d.warn(f),b&&b(p(400,f));if(a.mimetype&&"application/x-pkcs12"!==a.mimetype&&"application/octet-stream"!==a.mimetype||a.headers&&a.headers["content-type"]&&"application/x-pkcs12"!==a.headers["content-type"]&&"application/octet-stream"!==a.headers["content-type"])return f="Invalid Cert",d.warn(f,a),b&&b(p(400,f));try{h.unlinkSync(e.Gateway.CERT_FILE_PATH)}catch(g){}h.rename(c,e.Gateway.CERT_FILE_PATH,function(a){if(a){d.error("cert rename error",a);try{h.unlinkSync(c)}catch(g){}return f="Invalid filename",b&&b(p(400,f))}return s.registered=!0,"https"===e.Server.service.protocol||"mqtts"===e.Server.mqtt.protocol?(f="Upload Success and Restarting app now",setTimeout(function(){m.process("restart")},2e3)):f="Upload Success",b&&b(null,f)})},s.getSensorDrivers=function(a){var b=s.baseUrl;b+="/api/sensorDrivers",d.info("[getSensorDrivers] url",b),j.get(b,f.clone(s.requestOptions),function(b,c,e){return d.info("[getSensorDrivers] body",b,e),b?a&&a(b):2!==Math.floor(c.statusCode/100)?a&&a(p(c.statusCode)):a&&a(null,e)})},s.getGatewayModels=function(a){var b=s.baseUrl;b+="/api/gatewayModels",d.info("[getGatewayModels] url",b),j.get(b,f.clone(s.requestOptions),function(b,c,e){return d.info("[getGatewayModels] body",b,e),b?a&&a(b):2!==Math.floor(c.statusCode/100)?a&&a(p(c.statusCode)):a&&a(null,e)})}}),c.register("./store.js",function(a,b,c){"use strict";function G(){var b,a=f.freemem()/f.totalmem()*100;j.info("Memory %s%[%s/%s] limit: %s%",a,f.freemem(),f.totalmem(),t),t&&t>a?(j.error("Disable storing data due to memory full"),B=!0):B=!1,i.check("/",function(a,b,c){"READY"===c&&a&&r>b/a*100?(j.warn("Filesystem full %s/%s < %s%",b,a,r),g.readdir(q,function(a,b){a||h.isEmpty(b)||(h.each(b,function(a){if(a.match(/^device_\S+\.log.+/)){try{g.unlinkSync(q+a)}catch(b){j.warn("Delete log file failure",b)}j.warn("Delete logs due to filesystem full",a)}}),i.check("/",function(a,b,c){"READY"===c&&a&&s>b/a*100?(j.error("Disable storing data due to filesystem full"),A=!0):A=!1}))})):(j.info("Filesystem %s/%s > %s%",b,a,r),A=!1)}),b=f.uptime(),b>u&&F.getFirst(function(a,c){var d=c&&c.message&&c.message[0];d&&d.b&&d.u&&(d.b!==v||d.u<1e3*(b-u))&&(j.error("Detected too old data, oldest=%j",d,c),j.error("msg.u[%d] < ((uptime - REBOOT_IN_OFFLINE_INTERVAL)[%d] *1000)",d.u,b-u),k.emit("store","tooold",c,F.size()))}),setTimeout(G,o)}function H(){0===E.size()&&z&&(E.clean(),y=1,z=!1,setTimeout(function(){z=!0},o))}var w,E,d=c("mkdirp"),e=c("dirty"),f=c("os"),g=c("fs"),h=c("lodash"),i=c("diskspace"),j=c("log4js").getLogger("Store"),k=c("./utils").monitor,l=c("config"),m=l.Store&&l.Store.baseDir||"/var/lib/sensorjs/",n=l.Store&&l.Store.currentFile||"db.dirty",o=l.Store&&l.Store.cleanUpInterval||36e5,p="/proc/sys/kernel/random/boot_id",q=l.Gateway&&l.Gateway.logBaseDir||"/var/log/sensorjs/",r=l.Store&&l.Store.logFlushFilesystemLimit||10,s=l.Store&&l.Store.storeDisableFilesystemLimit||3,t=l.Store&&l.Store.storeDisableMemoryLimit||0,u=l.Store&&l.Store.rebootInOfflineInterval||86400,v=parseInt(g.readFileSync(p).slice(0,8),16).toString(36),x=!1,y=0,z=!0,A=!1,B=!1,C={},D=!1,F=a.exports={};F.init=function(b){if(x)return b&&b();x=!0;try{d.sync(m),E=e(m+n)}catch(c){j.error("use memory db instead due to persistent db failure",c),E=e()}["forEach","size"].forEach(function(b){a.exports[b]=E[b].bind(E)}),E.on("error",function(a){j.error("error on loading",a)}),E.on("load",function(){return y=Number(E.getLastKey(),10)||0,y++,H(),G(),b&&b()})},F.encode=function(a){var b,c;if(D)return b=!1,h.each(h.isArray(a.message)?a.message:[a.message],function(a){!a.t&&a.b&&a.u&&C[a.b].d&&(a.t=a.u+C[a.b].d),h.isObject(a.v)&&(b=!0)}),c=h.zip(h.flatten(a.message,"t"),h.flatten(a.message,"v")),{topic:a.topic,message:b?JSON.stringify(c):""+c}},F.getFirst=function(a){var b=E.getFirstKey();return b?a(b,E.get(b)):void 0},F.getLast=function(a){var b=E.getLastKey();return b?a(b,E.get(b)):void 0},F.push=w=function(a){return B||A?void j.error("push failure due to resource limit"):(h.each(h.isArray(a.message)?a.message:[a.message],function(a){a.u&&!a.b&&(a.b=v)}),E.set(y++,a),void k.emit("store","new"))},F.rm=function(a){E.rm(a),H()},F.timeSync=function(){var b,c,d,a=[];C[v]||(d=Date.now(),c=parseInt(1e3*f.uptime(),10),C[v]={u:c,d:d-c}),E.forEach(function(b,c){var d=h.isArray(c.message)?h.last(c.message):c.message;C[d.b]||(C[d.b]={}),j.debug("timeSync: before",C[d.b]),d.t&&(C[d.b].d||(C[d.b].d=d.t-d.u)),C[d.b].u=d.u,a.length&&h.last(a)===d.b||a.push(d.b),j.debug("timeSync: after",C[d.b]),j.debug("timeSync: bootArr",a)}),h.last(a)!==v&&j.info("timeSync: [%s] %s + [%s]",v,new Date(C[v].d).toISOString(),C[v].u/1e3),b=C[v],h.eachRight(a,function(a){C[a].d||(C[a].d=b.d-C[a].u),b=C[a],j.info("timeSync: [%s] %s + [%s]sec",a,new Date(C[a].d).toISOString(),C[a].u/1e3)}),D=!0}}),c.register("./utils.js",function(a,b,c){"use strict";function j(){d.EventEmitter.call(this)}function n(a,b){var c;switch(a||(a="mac"),a){case"mac":if(k)return b(null,k);i(function(a,d){return!a&&d&&(c=(""+d).replace(/:/g,"").toLowerCase(),k=c),b(a,c)});break;case"mac+filesystem":if(l)return b(null,l);g("blkid -t LABEL=rootfs -s UUID -o value",{timeout:5e3,killSignal:"SIGKILL"},function(a,d){return!a&&d&&(c+=(""+d).trim(),c.replace(/-/g,""),c=parseInt(c,16).toString(36),l=c),b(a,c)});break;case"bbbserial":if(m)return b(null,m);g("hexdump -e '8/1 \"%c\"' /sys/bus/i2c/devices/0-0050/eeprom -s 16 -n 12",{timeout:5e3,killSignal:"SIGKILL"},function(a,d){return!a&&d&&(c=(""+d).trim(),m=c),b(a,c)});break;default:return b(Error("unknown type",a))}}var k,l,m,o,d=c("events"),e=c("log4js").getLogger("Utils"),f=c("util"),g=c("child_process").exec,h=c("async"),i=c("getmac").getMac;f.inherits(j,d.EventEmitter),a.exports.monitor=new j,a.exports.statusError=function(a,b){var c=Error(b?a+" "+b:""+a);return c.statusCode=a,c},a.exports.isValidTime=function(a){return a||(a=Date.now()),a>1388502e6},a.exports.getId=n,a.exports.getBoardInfo=function(a){if(o)return a(null,o);o={};var b=setTimeout(function(){return e.error("[getBoardInfo] blocked",o),b=null,a&&a(null,o)},1e3);h.series([function(a){n("mac",function(b,c){return!b&&c&&(o={macaddress:c}),a()})},function(a){g("hexdump -e '8/1 \"%c\"' /sys/bus/i2c/devices/0-0050/eeprom -s 4 -n 24",{timeout:5e3,killSignal:"SIGKILL"},function(b,c){if(!b&&c){var d=(""+c).trim();o.model=d.substring(0,8),o.rev=d.substring(8,12),o.serial=d.substring(12,24)}return a()})}],function(c){return b?(clearTimeout(b),b=null,a&&a(c,o)):void e.error("[getBoardInfo] timeout",o)})}}),b.exports=c("./app.js")}(require,module);
